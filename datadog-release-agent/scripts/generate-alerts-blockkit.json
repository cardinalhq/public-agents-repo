{
  "schemaVersion": 1,
  "name": "generate-alerts-blockkit",
  "description": "",
  "language": "python",
  "code": "import sys\nimport json\nfrom datetime import datetime\nfrom typing import Dict, List, Any, Optional\n\ndef format_timestamp(epoch_ms: int) -\u003e str:\n    \"\"\"Convert epoch milliseconds to human-readable timestamp.\"\"\"\n    try:\n        dt = datetime.utcfromtimestamp(epoch_ms / 1000)\n        return dt.strftime(\"%b %d, %Y at %-I:%M %p UTC\").replace(\" 0\", \" \")\n    except Exception as e:\n        print(f\"Error formatting timestamp {epoch_ms}: {e}\", file=sys.stderr)\n        return \"Invalid timestamp\"\n\ndef get_priority_emoji(priority: str) -\u003e str:\n    \"\"\"Map priority levels to emojis.\"\"\"\n    priority_lower = priority.lower() if priority else \"\"\n    \n    if priority_lower in [\"high\", \"critical\"]:\n        return \"üî¥\"\n    elif priority_lower in [\"normal\", \"medium\"]:\n        return \"üü°\"\n    elif priority_lower == \"low\":\n        return \"üü¢\"\n    else:\n        return \"‚ö™\"  # default for unknown priorities\n\ndef create_alert_blocks(alert: Dict[str, Any]) -\u003e List[Dict[str, Any]]:\n    \"\"\"Create BlockKit blocks for a single alert.\"\"\"\n    blocks = []\n    \n    # Alert name and priority\n    alert_name = alert.get(\"alertName\", \"Unknown Alert\")\n    alert_url = alert.get(\"alert_url\")\n    priority = alert.get(\"priority\", \"unknown\")\n    priority_emoji = get_priority_emoji(priority)\n    \n    # Make alert name clickable if URL exists\n    if alert_url:\n        alert_text = f\"*\u003c{alert_url}|{alert_name}\u003e*\\n{priority_emoji} Priority: *{priority.upper()}*\"\n    else:\n        alert_text = f\"*{alert_name}*\\n{priority_emoji} Priority: *{priority.upper()}*\"\n    \n    # Add service if it exists and is not \"undefined\"\n    service = alert.get(\"service\")\n    if service and service.lower() != \"undefined\":\n        alert_text += f\"\\nService: `{service}`\"\n    \n    # Add timestamp\n    timestamp = alert.get(\"timestamp\")\n    if timestamp:\n        formatted_time = format_timestamp(timestamp)\n        alert_text += f\"\\nTime: {formatted_time}\"\n    \n    # Add expr (query) if exists\n    expr = alert.get(\"expr\")\n    if expr:\n        alert_text += f\"\\nQuery: `{expr}`\"\n    \n    # Main alert section\n    blocks.append({\n        \"type\": \"section\",\n        \"text\": {\n            \"type\": \"mrkdwn\",\n            \"text\": alert_text\n        }\n    })\n    \n    # Add graph image if exists\n    snap_url = alert.get(\"snap_url\")\n    if snap_url:\n        blocks.append({\n            \"type\": \"image\",\n            \"image_url\": snap_url,\n            \"alt_text\": f\"Graph for {alert_name}\"\n        })\n    \n    # Add monitor link button if exists (and not already linked in title)\n    if alert_url:\n        blocks.append({\n            \"type\": \"actions\",\n            \"elements\": [\n                {\n                    \"type\": \"button\",\n                    \"text\": {\n                        \"type\": \"plain_text\",\n                        \"text\": \"View Monitor\",\n                        \"emoji\": True\n                    },\n                    \"url\": alert_url,\n                    \"action_id\": f\"view_monitor_{alert.get('id', 'unknown')}\"\n                }\n            ]\n        })\n    \n    # Add divider after each alert\n    blocks.append({\n        \"type\": \"divider\"\n    })\n    \n    return blocks\n\ndef generate_blockkit(data: Dict[str, Any]) -\u003e Dict[str, Any]:\n    \"\"\"Generate Slack BlockKit format from alert data.\"\"\"\n    blocks = []\n    \n    # Header section\n    header = data.get(\"header\", \"üö® Alert Summary\")\n    blocks.append({\n        \"type\": \"header\",\n        \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": header,\n            \"emoji\": True\n        }\n    })\n    \n    blocks.append({\n        \"type\": \"divider\"\n    })\n    \n    # Process events/alerts\n    events = data.get(\"events\", [])\n    \n    if not events:\n        blocks.append({\n            \"type\": \"section\",\n            \"text\": {\n                \"type\": \"mrkdwn\",\n                \"text\": \"_No alerts to display._\"\n            }\n        })\n    else:\n        print(f\"Processing {len(events)} alerts\", file=sys.stderr)\n        for idx, alert in enumerate(events):\n            print(f\"Processing alert {idx + 1}: {alert.get('alertName', 'Unknown')}\", file=sys.stderr)\n            alert_blocks = create_alert_blocks(alert)\n            blocks.extend(alert_blocks)\n    \n    return {\"blocks\": blocks}\n\ndef run(input_data: Dict[str, Any]) -\u003e Dict[str, Any]:\n    \"\"\"Main entry point for the script.\"\"\"\n    print(\"Starting BlockKit generation\", file=sys.stderr)\n    print(f\"Input data: {json.dumps(input_data, indent=2)}\", file=sys.stderr)\n    \n    try:\n        result = generate_blockkit(input_data)\n        print(f\"Generated {len(result['blocks'])} blocks\", file=sys.stderr)\n        return result\n    except Exception as e:\n        print(f\"Error generating BlockKit: {e}\", file=sys.stderr)\n        import traceback\n        traceback.print_exc(file=sys.stderr)\n        # Return error block\n        return {\n            \"blocks\": [\n                {\n                    \"type\": \"section\",\n                    \"text\": {\n                        \"type\": \"mrkdwn\",\n                        \"text\": f\"‚ùå Error generating alert blocks: {str(e)}\"\n                    }\n                }\n            ]\n        }\n\nif __name__ == \"__main__\":\n    try:\n        # Read input from stdin\n        input_text = sys.stdin.read()\n        print(f\"Received input: {input_text[:200]}...\", file=sys.stderr)\n        \n        input_data = json.loads(input_text)\n        \n        # Run the main function\n        result = run(input_data)\n        \n        # Output result to stdout as JSON\n        print(json.dumps(result, indent=2))\n        \n    except json.JSONDecodeError as e:\n        print(f\"Error parsing input JSON: {e}\", file=sys.stderr)\n        sys.exit(1)\n    except Exception as e:\n        print(f\"Unexpected error: {e}\", file=sys.stderr)\n        import traceback\n        traceback.print_exc(file=sys.stderr)\n        sys.exit(1)",
  "environmentVariables": [],
  "inputSchema": {
    "properties": {
      "events": {
        "description": "Array of alert events",
        "type": "array"
      },
      "header": {
        "description": "Header text for the alert summary",
        "type": "string"
      }
    },
    "type": "object"
  },
  "execution": {
    "timeoutSeconds": 30,
    "workingDirectory": "workspace"
  },
  "createdAt": "2025-12-30T00:18:14Z",
  "updatedAt": "2025-12-30T00:32:31Z"
}