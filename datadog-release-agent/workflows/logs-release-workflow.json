{
  "objective": "Perform a release health check by analyzing log patterns and severity distributions before and after a deployment. When guardrails trigger or differences are detected, execute the log-release-analysis-chart script to generate visualization.",
  "steps": [
    "## Step 1: Setup",
    "- Get current time (for reference in output).",
    "- Define windows:",
    "  - **Pre:** [release_time - N, release_time)",
    "  - **Post:** [release_time, release_time + N)",
    "## Step 2: Log Analysis",
    "**Severity Definitions:**",
    "- **WARN+** if level/status ∈ {warn, warning, error, fatal, critical}",
    "- **ERROR+** if level/status ∈ {error, fatal, critical}",
    "**Analysis Steps:**",
    "1) **Total logs**",
    "   - total_pre  = count(logs(service_name, pre))",
    "   - total_post = count(logs(service_name, post))",
    "2) **WARN+ logs**",
    "   - warn_pre  = count(WARN+ logs in pre)",
    "   - warn_post = count(WARN+ logs in post)",
    "3) **WARN+ rate regression (percentage points)**",
    "   - pct_pre  = (warn_pre / total_pre) * 100 (0 if total_pre==0)",
    "   - pct_post = (warn_post / total_post) * 100 (0 if total_post==0)",
    "   - delta_pp = pct_post - pct_pre",
    "   - warn_regression = (total_pre\u003e0 \u0026\u0026 total_post\u003e0 \u0026\u0026 warn_post\u003e=1 \u0026\u0026 delta_pp \u003e= threshold_pp)",
    "4) **Stopped patterns (any severity)**",
    "   - Build pattern counts for **all logs** in pre/post using the same patterning logic.",
    "   - Collect pre_all_patterns: List of {pattern, count} from pre window (all severities)",
    "   - Collect post_all_patterns: List of {pattern, count} from post window (all severities)",
    "   - Flag **Stopped Pattern** when: pre_count(pattern) \u003e= min_pattern_count AND post_count(pattern) == 0.",
    "5) **New error patterns (true errors only)**",
    "   - Build pattern counts using **ERROR+ logs only**.",
    "   - Collect pre_all_patterns: List of {pattern, count} from pre window (all severities)",
    "   - Collect post_all_patterns: List of {pattern, count} from post window (all severities)",
    "   - Flag **New Error Pattern** when: pre_err_count(pattern) == 0 AND post_err_count(pattern) \u003e= min_pattern_count.",
    "## Step 3: Conditional Chart Generation",
    "**If any of the following conditions are TRUE, execute the script `log-release-analysis-chart`:**",
    "- WARN+ Regression guardrail is triggered",
    "- Stopped Pattern(s) detected",
    "- New Error Pattern(s) detected",
    "**The script will:**",
    "- Fetch WARN+/ERROR timeseries data from the local logs endpoint",
    "- Render a continuous pre/post release chart with a release boundary line",
    "- Annotate detected patterns (NEW Error Patterns and STOPPED Patterns) on the chart",
    "- Upload the rendered chart to Slack channel",
    "- Return Blockit-rendered image/chart blocks for release review"
  ],
  "guardrails": [
    "Log Analysis Thresholds",
    "- Flag **WARN+ Regression** if `warn_regression == true` (uses `threshold_pp`, default **0.01 pp**)",
    "- Flag **Stopped Pattern** if `pre_count \u003e= min_pattern_count` and `post_count == 0`",
    "- Flag **New Error Pattern** only from **ERROR+ logs** where `pre_err_count == 0` and `post_err_count \u003e= min_pattern_count`",
    "- Execute `log-release-analysis-chart` script ONLY when guardrails trigger"
  ],
  "queries": [],
  "knowledge": [],
  "workflows": [],
  "scripts": [
    "log-release-analysis-chart"
  ],
  "trigger": "http"
}