{
  "name": "aws-console-drift-detection",
  "text": "What AWS resource modifications were made by human console users outside of Terraform in the past hour?",
  "query_type": "snowflake_sql",
  "query": "SELECT \n    EVENTTIME,\n    EVENTNAME,\n    EVENTSOURCE,\n    SPLIT_PART(USERIDENTITY:principalId::STRING, ':', 2) as aws_username,\n    USERIDENTITY:type::STRING as user_type,\n    USERIDENTITY:arn::STRING as user_arn,\n    USERIDENTITY:sessionContext:sessionIssuer:userName::STRING as assumed_role_name,\n    USERAGENT,\n    AWSREGION,\n    RESOURCES,\n    REQUESTPARAMETERS\nFROM SAMPLE_DATABASE.SAMPLE_SCHEMA.SAMPLE_CLOUDTRAIL_TABLE\nWHERE EVENTTIME >= DATEADD(hour, -1, CURRENT_TIMESTAMP())\n  AND ERRORCODE IS NULL\n  AND (USERAGENT NOT LIKE '%terraform%' AND USERAGENT NOT LIKE '%Terraform%')\n  -- Exclude read-only operations\n  AND EVENTNAME NOT LIKE 'Describe%'\n  AND EVENTNAME NOT LIKE 'Get%'\n  AND EVENTNAME NOT LIKE 'List%'\n  AND EVENTNAME NOT LIKE 'Lookup%'\n  AND EVENTNAME NOT IN ('AssumeRole', 'AssumeRoleWithSAML', 'Decrypt', 'ConsoleLogin')\n  -- Human users only: Filter for console/CLI user agents\n  AND (\n    USERAGENT LIKE 'Mozilla%'  -- Web browser (Console)\n    OR USERAGENT LIKE 'aws-cli%'  -- AWS CLI\n    OR USERAGENT LIKE '%Safari%'  -- Safari browser\n    OR USERAGENT LIKE '%Chrome%'  -- Chrome browser\n    OR USERAGENT LIKE '%Firefox%'  -- Firefox browser\n  )\n  -- Exclude AWS service roles\n  AND USERIDENTITY:arn::STRING NOT LIKE '%AWSServiceRole%'\nORDER BY EVENTTIME DESC\nLIMIT 100",
  "status": "private",
  "meta": {
    "sql_description": "Show recent CloudTrail events from human users (console/CLI) within the last {lookback_hours} hours, excluding read-only operations (matching {exclude_describe}, {exclude_get}, {exclude_list}, {exclude_lookup}), specific event types ({exclude_assumerole}, {exclude_assumerole_saml}, {exclude_decrypt}, {exclude_consolelogin}), Terraform activity ({exclude_terraform_lower}, {exclude_terraform_upper}), and AWS service roles ({exclude_service_role}). Filter for human user agents including browsers ({browser_mozilla}, {browser_safari}, {browser_chrome}, {browser_firefox}) and CLI ({cli_pattern}). Limited to {max_results} results.",
    "sql_placeholders": [
      {
        "name": "lookback_hours",
        "original_value": "-1",
        "type": "int"
      },
      {
        "name": "exclude_terraform_lower",
        "original_value": "%terraform%",
        "type": "string"
      },
      {
        "name": "exclude_terraform_upper",
        "original_value": "%Terraform%",
        "type": "string"
      },
      {
        "name": "exclude_describe",
        "original_value": "Describe%",
        "type": "string"
      },
      {
        "name": "exclude_get",
        "original_value": "Get%",
        "type": "string"
      },
      {
        "name": "exclude_list",
        "original_value": "List%",
        "type": "string"
      },
      {
        "name": "exclude_lookup",
        "original_value": "Lookup%",
        "type": "string"
      },
      {
        "name": "exclude_assumerole",
        "original_value": "AssumeRole",
        "type": "string"
      },
      {
        "name": "exclude_assumerole_saml",
        "original_value": "AssumeRoleWithSAML",
        "type": "string"
      },
      {
        "name": "exclude_decrypt",
        "original_value": "Decrypt",
        "type": "string"
      },
      {
        "name": "exclude_consolelogin",
        "original_value": "ConsoleLogin",
        "type": "string"
      },
      {
        "name": "browser_mozilla",
        "original_value": "Mozilla%",
        "type": "string"
      },
      {
        "name": "cli_pattern",
        "original_value": "aws-cli%",
        "type": "string"
      },
      {
        "name": "browser_safari",
        "original_value": "%Safari%",
        "type": "string"
      },
      {
        "name": "browser_chrome",
        "original_value": "%Chrome%",
        "type": "string"
      },
      {
        "name": "browser_firefox",
        "original_value": "%Firefox%",
        "type": "string"
      },
      {
        "name": "exclude_service_role",
        "original_value": "%AWSServiceRole%",
        "type": "string"
      },
      {
        "name": "max_results",
        "original_value": "100",
        "type": "int"
      }
    ],
    "sql_template": "SELECT \n    EVENTTIME,\n    EVENTNAME,\n    EVENTSOURCE,\n    SPLIT_PART(USERIDENTITY:principalId::STRING, ':', 2) as aws_username,\n    USERIDENTITY:type::STRING as user_type,\n    USERIDENTITY:arn::STRING as user_arn,\n    USERIDENTITY:sessionContext:sessionIssuer:userName::STRING as assumed_role_name,\n    USERAGENT,\n    AWSREGION,\n    RESOURCES,\n    REQUESTPARAMETERS\nFROM SAMPLE_DATABASE.SAMPLE_SCHEMA.SAMPLE_CLOUDTRAIL_TABLE\nWHERE EVENTTIME >= DATEADD(hour, ?, CURRENT_TIMESTAMP())\n  AND ERRORCODE IS NULL\n  AND (USERAGENT NOT LIKE ? AND USERAGENT NOT LIKE ?)\n  AND EVENTNAME NOT LIKE ?\n  AND EVENTNAME NOT LIKE ?\n  AND EVENTNAME NOT LIKE ?\n  AND EVENTNAME NOT LIKE ?\n  AND EVENTNAME NOT IN (?, ?, ?, ?)\n  AND (\n    USERAGENT LIKE ?\n    OR USERAGENT LIKE ?\n    OR USERAGENT LIKE ?\n    OR USERAGENT LIKE ?\n    OR USERAGENT LIKE ?\n  )\n  AND USERIDENTITY:arn::STRING NOT LIKE ?\nORDER BY EVENTTIME DESC\nLIMIT ?"
  },
  "datasource_name": "snowflake",
  "type": "snowflake"
}