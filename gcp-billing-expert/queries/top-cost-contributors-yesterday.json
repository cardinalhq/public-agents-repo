{
  "name": "top-cost-contributors-yesterday",
  "text": "What are my top cost contributors?",
  "query_type": "bigquery_sql",
  "query": "SELECT \n  project.id as project_id,\n  service.description as service_type,\n  sku.description as sku_description,\n  SUM(cost) as total_cost_last_7days,\n  SUM(cost) / 7 as daily_cost,\n  (SUM(cost) / 7) * 30 as projected_monthly_cost,\n  COUNT(*) as cost_entries,\n  location.location as location\nFROM `chip_billing.gcp_billing_export_v1_01D01E_9B88C7_8078BC`\nWHERE cost > 0\n  AND DATE(usage_start_time) >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)\nGROUP BY project_id, service_type, sku_description, location\nHAVING daily_cost > 0.10\nORDER BY total_cost_last_7days DESC\nLIMIT 50",
  "status": "private",
  "meta": {
    "query_description": "Show GCP billing costs grouped by project, service, SKU, and location for the last {lookback_days} days, filtering out costs below {min_cost} and excluding services with daily cost below {min_daily_cost}, limited to top {result_limit} results",
    "question_template": "What are my top {result_limit} cost contributors over the last {lookback_days} days?",
    "sql_flow_diagram": "flowchart TD\n    Q[\"Question: What are my top cost contributors?\"]\n    T1[(\"gcp_billing_export_v1_01D01E_9B88C7_8078BC\")]\n    \n    F1{\"Filter: cost > 0 AND<br/>DATE(usage_start_time) >= last 7 days\"}\n    \n    GROUP{\"Group By:<br/>project_id, service_type,<br/>sku_description, location\"}\n    \n    AGG{\"Aggregations:<br/>SUM(cost) as total_cost_last_7days<br/>SUM(cost)/7 as daily_cost<br/>(SUM(cost)/7)*30 as projected_monthly_cost<br/>COUNT(*) as cost_entries\"}\n    \n    F2{\"Having:<br/>daily_cost > 0.10\"}\n    \n    SORT{\"Order By:<br/>total_cost_last_7days DESC<br/>LIMIT 50\"}\n    \n    R[\"Result: Top 50 cost contributors<br/>with project, service, SKU,<br/>location, costs and projections\"]\n    \n    Q --> T1\n    T1 --> F1\n    F1 --> GROUP\n    GROUP --> AGG\n    AGG --> F2\n    F2 --> SORT\n    SORT --> R",
    "query_placeholders": [
      {
        "name": "min_cost",
        "original_value": "0",
        "type": "double"
      },
      {
        "name": "lookback_days",
        "original_value": "7",
        "type": "int"
      },
      {
        "name": "min_daily_cost",
        "original_value": "0.10",
        "type": "double"
      },
      {
        "name": "result_limit",
        "original_value": "50",
        "type": "int"
      }
    ],
    "query_template": "SELECT \n  project.id as project_id,\n  service.description as service_type,\n  sku.description as sku_description,\n  SUM(cost) as total_cost_last_7days,\n  SUM(cost) / 7 as daily_cost,\n  (SUM(cost) / 7) * 30 as projected_monthly_cost,\n  COUNT(*) as cost_entries,\n  location.location as location\nFROM `chip_billing.gcp_billing_export_v1_01D01E_9B88C7_8078BC`\nWHERE cost > {{min_cost}}\n  AND DATE(usage_start_time) >= DATE_SUB(CURRENT_DATE(), INTERVAL {{lookback_days}} DAY)\nGROUP BY project_id, service_type, sku_description, location\nHAVING daily_cost > {{min_daily_cost}}\nORDER BY total_cost_last_7days DESC\nLIMIT {{result_limit}}"
  },
  "datasource_name": "google_bigquery"
}