{
  "name": "bigquery-expensive-queries",
  "text": "What are my most expensive Google BigQuery queries and why are they very expensive?",
  "query_type": "bigquery_sql",
  "query": "\nWITH expensive_queries AS (\n  SELECT \n    job_id,\n    creation_time,\n    user_email,\n    project_id,\n    state,\n    total_bytes_billed,\n    total_bytes_processed,\n    total_slot_ms,\n    TIMESTAMP_DIFF(end_time, start_time, SECOND) as duration_seconds,\n    cache_hit,\n    query,\n    -- Calculate estimated cost (BigQuery costs $6.25 per TB processed in on-demand pricing)\n    ROUND((total_bytes_billed / POW(10, 12)) * 6.25, 2) as estimated_cost_usd,\n    -- Calculate slot hours for compute cost analysis\n    ROUND(total_slot_ms / (1000 * 60 * 60), 2) as slot_hours\n  FROM `region-us.INFORMATION_SCHEMA.JOBS`\n  WHERE \n    job_type = 'QUERY'\n    AND state = 'DONE'\n    AND creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)\n    AND total_bytes_billed > 0\n  ORDER BY total_bytes_billed DESC\n  LIMIT 20\n)\nSELECT \n  job_id,\n  creation_time,\n  user_email,\n  project_id,\n  estimated_cost_usd,\n  ROUND(total_bytes_billed / POW(10, 9), 2) as gb_billed,\n  ROUND(total_bytes_processed / POW(10, 9), 2) as gb_processed,\n  slot_hours,\n  duration_seconds,\n  cache_hit,\n  CASE \n    WHEN cache_hit THEN 'Cached (No cost)'\n    WHEN total_bytes_billed > 1000000000000 THEN 'Very Large Scan (>1TB)'\n    WHEN total_bytes_billed > 100000000000 THEN 'Large Scan (>100GB)'\n    WHEN slot_hours > 10 THEN 'High Compute Cost'\n    ELSE 'Normal'\n  END as cost_driver,\n  LEFT(query, 200) as query_preview\nFROM expensive_queries\nORDER BY estimated_cost_usd DESC\n",
  "status": "private",
  "meta": {
    "query_description": "Show the top {result_limit} most expensive BigQuery queries from the last {lookback_days} days with status {job_state}, filtering for queries with bytes billed greater than {min_bytes_billed}. Categorizes queries by cost drivers using thresholds: very large scans (>{very_large_scan_bytes} bytes), large scans (>{large_scan_bytes} bytes), and high compute (>{high_slot_hours} slot hours). Preview shows first {query_preview_length} characters of each query.",
    "question_template": "What are my top {result_limit} most expensive BigQuery queries from the last {lookback_days} days?",
    "sql_flow_diagram": "flowchart TD\n    Q[\"Question: What are my most expensive<br/>Google BigQuery queries and why<br/>are they expensive?\"]\n    T1[(\"region-us.INFORMATION_SCHEMA.JOBS\")]\n    \n    F1{\"Filter:<br/>job_type = 'QUERY'<br/>state = 'DONE'<br/>Last 30 days<br/>total_bytes_billed > 0\"}\n    \n    CALC1[\"Calculate Metrics:<br/>- estimated_cost_usd = bytes_billed/TB * $6.25<br/>- duration_seconds<br/>- slot_hours\"]\n    \n    SORT1{\"Sort by<br/>total_bytes_billed DESC<br/>LIMIT 20\"}\n    \n    CTE[\"CTE: expensive_queries\"]\n    \n    CALC2[\"Transform Data:<br/>- Convert bytes to GB<br/>- Keep slot_hours, duration<br/>- Truncate query preview\"]\n    \n    CASE{\"Categorize cost_driver:<br/>- Cached (No cost)<br/>- Very Large Scan (>1TB)<br/>- Large Scan (>100GB)<br/>- High Compute Cost<br/>- Normal\"}\n    \n    SORT2{\"Sort by<br/>estimated_cost_usd DESC\"}\n    \n    R[\"Result: Top 20 most expensive queries<br/>with cost breakdown, metrics,<br/>and expense reason classification\"]\n    \n    Q --> T1\n    T1 --> F1\n    F1 --> CALC1\n    CALC1 --> SORT1\n    SORT1 --> CTE\n    CTE --> CALC2\n    CALC2 --> CASE\n    CASE --> SORT2\n    SORT2 --> R",
    "query_placeholders": [
      {
        "name": "bigquery_jobs_table",
        "original_value": "region-us.INFORMATION_SCHEMA.JOBS",
        "type": "string"
      },
      {
        "name": "job_state",
        "original_value": "DONE",
        "type": "string"
      },
      {
        "name": "lookback_days",
        "original_value": "30",
        "type": "int"
      },
      {
        "name": "min_bytes_billed",
        "original_value": "0",
        "type": "int"
      },
      {
        "name": "result_limit",
        "original_value": "20",
        "type": "int"
      },
      {
        "name": "very_large_scan_bytes",
        "original_value": "1000000000000",
        "type": "int"
      },
      {
        "name": "large_scan_bytes",
        "original_value": "100000000000",
        "type": "int"
      },
      {
        "name": "high_slot_hours",
        "original_value": "10",
        "type": "int"
      },
      {
        "name": "query_preview_length",
        "original_value": "200",
        "type": "int"
      }
    ],
    "query_template": "WITH expensive_queries AS (\n  SELECT \n    job_id,\n    creation_time,\n    user_email,\n    project_id,\n    state,\n    total_bytes_billed,\n    total_bytes_processed,\n    total_slot_ms,\n    TIMESTAMP_DIFF(end_time, start_time, SECOND) as duration_seconds,\n    cache_hit,\n    query,\n    -- Calculate estimated cost (BigQuery costs $6.25 per TB processed in on-demand pricing)\n    ROUND((total_bytes_billed / POW(10, 12)) * 6.25, 2) as estimated_cost_usd,\n    -- Calculate slot hours for compute cost analysis\n    ROUND(total_slot_ms / (1000 * 60 * 60), 2) as slot_hours\n  FROM `{{bigquery_jobs_table}}`\n  WHERE \n    job_type = 'QUERY'\n    AND state = '{{job_state}}'\n    AND creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL {{lookback_days}} DAY)\n    AND total_bytes_billed > {{min_bytes_billed}}\n  ORDER BY total_bytes_billed DESC\n  LIMIT {{result_limit}}\n)\nSELECT \n  job_id,\n  creation_time,\n  user_email,\n  project_id,\n  estimated_cost_usd,\n  ROUND(total_bytes_billed / POW(10, 9), 2) as gb_billed,\n  ROUND(total_bytes_processed / POW(10, 9), 2) as gb_processed,\n  slot_hours,\n  duration_seconds,\n  cache_hit,\n  CASE \n    WHEN cache_hit THEN 'Cached (No cost)'\n    WHEN total_bytes_billed > {{very_large_scan_bytes}} THEN 'Very Large Scan (>1TB)'\n    WHEN total_bytes_billed > {{large_scan_bytes}} THEN 'Large Scan (>100GB)'\n    WHEN slot_hours > {{high_slot_hours}} THEN 'High Compute Cost'\n    ELSE 'Normal'\n  END as cost_driver,\n  LEFT(query, {{query_preview_length}}) as query_preview\nFROM expensive_queries\nORDER BY estimated_cost_usd DESC"
  },
  "datasource_name": "bigquery_query_insights",
  "type": "bigquery-query-insights"
}